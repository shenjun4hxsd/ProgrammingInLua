##ç¼–å†™Luaé€»è¾‘

&emsp;

ä¸ºå®ç°ä»£ç çƒ­æ›´æ–°ï¼Œåœ¨Unity3Dä¸­ä½¿ç”¨luaï¼Œç„¶è€Œä¸ºæ­¤ä¹Ÿéœ€ä»˜å‡ºä¸å°‘ä»£ä»·ã€‚å…¶ä¸€ï¼Œä½¿ä»£ç ç»“æ„æ··ä¹±ï¼ˆå°½ç®¡å¯ä»¥ä¼˜åŒ–ï¼‰ï¼Œå…¶äºŒé™ä½äº†è¿è¡Œé€Ÿåº¦ï¼Œå…¶ä¸‰å¢åŠ å­¦ä¹ æˆæœ¬ï¼ˆè¿˜è¦å¤šå­¦ä¸€é—¨è¯­è¨€ï¼‰ã€‚ä¸ºäº†çƒ­æ›´æ–°ï¼Œæ‰€æœ‰çš„é€»è¾‘éƒ½è¦ç”¨luaç¼–å†™ï¼Œé‚£ä¹ˆæ€æ ·ç”¨luaç¼–å†™æ¸¸æˆé€»è¾‘å‘¢ï¼Ÿ

&emsp;

####ä¸€ã€Lua çš„ Update æ–¹æ³•

ç¬¬ä¸€ç¯‡â€œä»£ç çƒ­æ›´æ–°â€æ¼”ç¤ºäº†ç”¨luaæ‰“å°HelloWorldçš„æ–¹æ³•ï¼Œç¬¬äºŒç¯‡â€œèµ„æºçƒ­æ›´æ–°â€æ¼”ç¤ºäº†åŠ è½½å¦å…‹æ¨¡å‹çš„æ–¹æ³•ã€‚è¿™ä¸€ç¯‡è¦æŠŠä¸¤è€…ç»“åˆèµ·æ¥ï¼Œç”¨luaå®ç°â€œç”¨é”®ç›˜æ§åˆ¶å¦å…‹ç§»åŠ¨â€çš„åŠŸèƒ½ã€‚ç”¨Luaå’Œç”¨c#ç¼–å†™çš„Unity3Dç¨‹åºå¤§åŒå°å¼‚ï¼Œåªéœ€æ­£ç¡®ä½¿ç”¨APIå³å¯ã€‚

**1ï¼‰ã€Update æ–¹æ³•**

å‡ºäºæ•ˆç‡çš„è€ƒè™‘ï¼Œtoluaæä¾›äº†åä¸ºUpdateBeatçš„å¯¹è±¡ï¼Œåœ¨LuaFrameworkä¸­ï¼Œåªéœ€ç»™UpdateBeatæ·»åŠ å›è°ƒå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¾¿ä¼šæ¯å¸§æ‰§è¡Œï¼Œç›¸å½“äºMonobehaviourçš„Updateæ–¹æ³•ã€‚Luaä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```lua
    function Main()                                 
        UpdateBeat:Add(Update, self)
    end
  
    function Update()
        LuaFramework.Util.Log("æ¯å¸§æ‰§è¡Œä¸€æ¬¡");
    end
```

é™¤äº†UpdateBeatï¼Œtoluaè¿˜æä¾›äº†LateUpdateBeatå’ŒFixedUpdateBeatï¼Œå¯¹åº”äºMonobehaviourä¸­çš„LateUpdateå’ŒFixedUpdateã€‚

&emsp;

**2ï¼‰ã€æ§åˆ¶å¦å…‹**

ç°åœ¨ç¼–å†™â€œç”¨é”®ç›˜æ§åˆ¶å¦å…‹ç§»åŠ¨â€çš„luaä»£ç ï¼ŒåŠ è½½å¦å…‹æ¨¡å‹åï¼Œä½¿ç”¨UpdateBeatæ³¨å†Œæ¯å¸§æ‰§è¡Œçš„Updateæ–¹æ³•ï¼Œç„¶ååœ¨Updateæ–¹æ³•ä¸­è°ƒç”¨UnityEngine.Inputç­‰APIå®ç°åŠŸèƒ½ã€‚ä»£ç å¦‚ä¸‹ï¼š

```lua
    local go; --åŠ è½½çš„å¦å…‹æ¨¡å‹
    
    --ä¸»å…¥å£å‡½æ•°ã€‚ä»è¿™é‡Œå¼€å§‹luaé€»è¾‘
    function Main()       
            LuaHelper = LuaFramework.LuaHelper;
            resMgr = LuaHelper.GetResManager();
            resMgr:LoadPrefab('tank', { 'TankPrefab' }, OnLoadFinish);
    end
     
    --åŠ è½½å®Œæˆåçš„å›è°ƒ--
    function OnLoadFinish(objs)
            go = UnityEngine.GameObject.Instantiate(objs[0]);
            LuaFramework.Util.Log("LoadFinish");
            
            UpdateBeat:Add(Update, self)
    end
     
    --æ¯å¸§æ‰§è¡Œ
    function Update()
            LuaFramework.Util.Log("æ¯å¸§æ‰§è¡Œ");
            
            local Input = UnityEngine.Input;
            local horizontal = Input.GetAxis("Horizontal");
            local verticla = Input.GetAxis("Vertical");
            
            local x = go.transform.position.x + horizontal
            local z = go.transform.position.z + verticla
            go.transform.position = Vector3.New(x,0,z)
    end
```

è¿è¡Œæ¸¸æˆï¼Œå³å¯ç”¨é”®ç›˜çš„æ§åˆ¶å¦å…‹ç§»åŠ¨ã€‚

&emsp;


####äºŒã€è‡ªå®šä¹‰API

æ¡†æ¶ä¸­æä¾›äº†æ•°åä¸ªå¯ä¾›luaè°ƒç”¨çš„c#ç±»ï¼Œä½†è¿™äº›å¾€å¾€ä¸å¤Ÿç”¨ï¼Œéœ€è¦è‡ªå·±æ·»åŠ ï¼Œæœ¬èŠ‚å°†ä»‹ç»æ·»åŠ è‡ªå®šä¹‰APIçš„æ–¹æ³•ã€‚

**1ï¼‰ã€ç¼–å†™C#ç±»**

ä¾‹å¦‚ï¼Œç¼–å†™TestLuaFun.ç±»ï¼Œå®ƒåŒ…å«ä¸€ä¸ªé™æ€æ–¹æ³•Logï¼Œä¼šæ‰“å°å‡ºä¸¤è¡Œæ–‡æœ¬ã€‚

```csharp
    using UnityEngine;
    using System.Collections;
 
    public class TestLuaFun 
    {
        public static void Log() 
        {
            Debug.Log("ã€ŠUnity3Dç½‘ç»œæ¸¸æˆå®æˆ˜ã€‹æ˜¯ä¸€æœ¬å¥½ä¹¦ï¼");
            Debug.Log("ã€Šæ‰‹æŠŠæ‰‹æ•™ä½ ç”¨c#åˆ¶ä½œrpgæ¸¸æˆã€‹ä¹Ÿæ˜¯ä¸€æœ¬å¥½ä¹¦ï¼");
        }
    }
```

**2ï¼‰ã€ä¿®æ”¹CustomSetting**

æ‰“å¼€CustomSetting.csï¼Œåœ¨customTypeListä¸­æ·»åŠ ä¸€å¥â€œ_GT(typeof(TestLuaFun))â€ã€‚

```csharp
    //åœ¨è¿™é‡Œæ·»åŠ ä½ è¦å¯¼å‡ºæ³¨å†Œåˆ°luaçš„ç±»å‹åˆ—è¡¨
    public static BindType[] customTypeList =
    {
        // ...
        
        _GT(typeof(GameManager)),
        _GT(typeof(LuaManager)),
        _GT(typeof(PanelManager)),
        _GT(typeof(SoundManager)),
        _GT(typeof(TimerManager)),
        _GT(typeof(ThreadManager)),
        _GT(typeof(NetworkManager)),
        _GT(typeof(ResourceManager)),

        // åœ¨è¿™é‡Œæ·»åŠ å¯¼å‡ºæ³¨å†Œåˆ°luaçš„ç±»å‹ç±»æ ‡
        _GT(typeof(TestLuaFunc)),
    }
```

**3ï¼‰ã€ç”Ÿæˆwrapæ–‡ä»¶**

ç‚¹å‡»èœå•æ çš„Luaâ†’Clear wrap fileså’ŒLuaâ†’Generate Allï¼Œé‡æ–°ç”Ÿæˆwrapæ–‡ä»¶ã€‚ç”±äºåˆšåˆšåœ¨customTypeListæ·»åŠ äº†ç±»ï¼Œæ‰€ä»¥ä¼šç”ŸæˆTestLuaFunç±»çš„wrapæ–‡ä»¶TestLuaFunWrap.csã€‚


æ‰“å¼€TestLuaFunWrap.csï¼Œå¯ä»¥çœ‹åˆ°TestLuaFunæ³¨å†Œäº†Logæ–¹æ³•ã€‚

```csharp
    //this source code was auto-generated by tolua#, do not modify it
    using System;
    using LuaInterface;

    public class TestLuaFuncWrap
    {
        public static void Register(LuaState L)
        {
            L.BeginClass(typeof(TestLuaFunc), typeof(System.Object));
            L.RegFunction("Log", Log);
            L.RegFunction("New", _CreateTestLuaFunc);
            L.RegFunction("__tostring", ToLua.op_ToString);
            L.EndClass();
        }

        [MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]
        static int _CreateTestLuaFunc(IntPtr L)
        {
            try
            {
                int count = LuaDLL.lua_gettop(L);

                if (count == 0)
                {
                    TestLuaFunc obj = new TestLuaFunc();
                    ToLua.PushObject(L, obj);
                    return 1;
                }
                else
                {
                    return LuaDLL.luaL_throw(L, "invalid arguments to ctor method: TestLuaFunc.New");
                }
            }
            catch (Exception e)
            {
                return LuaDLL.toluaL_exception(L, e);
            }
        }

        [MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]
        static int Log(IntPtr L)
        {
            try
            {
                ToLua.CheckArgsCount(L, 0);
                TestLuaFunc.Log();
                return 0;
            }
            catch (Exception e)
            {
                return LuaDLL.toluaL_exception(L, e);
            }
        }
    }
```

4ï¼‰ã€æµ‹è¯•API


ä¿®æ”¹main.luaï¼Œè°ƒç”¨TestLuaFun.Log() ï¼Œå³å¯çœ‹åˆ°æ•ˆæœã€‚

```lua
    --ä¸»å…¥å£å‡½æ•°ã€‚ä»è¿™é‡Œå¼€å§‹luaé€»è¾‘
    function Main()                                 
        TestLuaFun.Log()  
    end
```

&emsp;

####ä¸‰ã€åŸç†

toluaå®ç°äº†LuaInterfaceï¼ŒæŠ›å¼€luaFrameworkï¼Œåªéœ€åˆ›å»ºluaè™šæ‹Ÿæœºï¼Œä¾¿èƒ½åœ¨c#ä¸­è°ƒç”¨luaä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```csharp
    using UnityEngine;
    using System.Collections;
    using LuaInterface;
 
    public class test : MonoBehaviour
    {
        void Start () 
        {
            //åˆå§‹åŒ–
            LuaState lua = new LuaState();
            LuaBinder.Bind(lua);
            //luaä»£ç 
            string luaStr =
                @"                
                    print('hello tolua#, å¹¿å‘Šæ‹›ç§Ÿ')
                    LuaFramework.Util.Log('HelloWorld');
                    TestLuaFun.Log()                
                ";
            //æ‰§è¡Œluaè„šæœ¬
            lua.DoString(luaStr);
        }
    } 
```

å®é™…ä¸ŠLuaFrameworkä¹Ÿæ˜¯ç”¨äº†ç›¸ä¼¼çš„æ–¹æ³•ï¼Œæ¡†æ¶å¯åŠ¨åï¼Œä¼šåˆ›å»ºLuaManagerã€LuaLooperçš„å®ä¾‹ã€‚LuaManageråˆ›å»ºluaè™šæ‹Ÿæœºå¹¶è°ƒç”¨Main.luaçš„Mainæ–¹æ³•ï¼ŒLuaLooperå¤„ç†äº†UpdateBeatç›¸å…³çš„äº‹æƒ…ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

```csharp
    void Awake() {
        loader = new LuaLoader();
        lua = new LuaState();
        this.OpenLibs();
        lua.LuaSetTop(0);

        LuaBinder.Bind(lua);
        DelegateFactory.Init();
        LuaCoroutine.Register(lua, this);
    }

    public void InitStart() {
        InitLuaPath();
        InitLuaBundle();
        this.lua.Start();    //å¯åŠ¨LUAVM
        this.StartMain();
        this.StartLooper();
    }
    
    void StartMain() {
        lua.DoFile("Main.lua");

        LuaFunction main = lua.GetFunction("Main");
        main.Call();
        main.Dispose();
        main = null;    
    }
    
    void StartLooper() {
        loop = gameObject.AddComponent<LuaLooper>();
        loop.luaState = lua;
    }
```

ğŸ”š